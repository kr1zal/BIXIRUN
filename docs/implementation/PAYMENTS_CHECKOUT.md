## Checkout (Оплата) — текущее состояние и финализационный чек‑лист

Документ фиксирует сделанные изменения по экрану оплаты и список шагов для
завершения реализации (техника и UX).

### Что реализовано

- Экран `app/checkout.tsx` с безопасным заголовком под Safe Area и кнопкой
  «назад» на `'/cart'`.
- Подключение реальных данных корзины из стора:
  - Список выбранных товаров и итог подтягиваются через `useCart` (`cartItems`,
    `cartSummary.total`).
- Тайлы способов оплаты в едином стиле с корзиной:
  - СБП (официальный логотип `assets/images/sbp-logo.png`).
  - Картой онлайн (иконка карты).
  - YooMoney.
  - Выделение только рамкой/фоном — размеры тайлов фиксированы (нет «прыжков»
    при выборе).
- Кнопка внизу всегда синяя и одного размера:
  - Текст меняется: «Оплатить СБП» (если выбран СБП) или «Оплатить онлайн»
    (карта/YooMoney).
- Модалки:
  - Выбор банка СБП (мок — редирект через Alert).
  - «Данные получателя» (имя/телефон) c сохранением в состоянии.
- Стиль как на странице корзины:
  - Фон `#F5F5F5`, белые карточки с мягкими тенями.
  - Типографика: основной текст 16/24 `#111827`, muted `#5F6368`; заголовки
    секций 18/22 жирные; «Итого» 20/24 жирный.
- Навигация/структура:
  - Скрытие таббара на `'/checkout'` в `components/AppLayout.tsx`.
  - Заголовок «Оформление заказа» опущен ниже «чёлки»/status bar.
- Прочее: линтер чистый; все изменения изолированы (нет запуска сервера/гита).

Затронутые файлы:

- `app/checkout.tsx`
- `components/AppLayout.tsx`
- `assets/images/sbp-logo.png`

### Временные заглушки (моки)

- Создание платежа — мок `mockCreatePayment()` с фейковым `confirmation_url`.
- СБП модалка — выбор банка завершает «переходом в приложение банка» через
  Alert.

---

## Чек‑лист финализации

### A. Бэкенд/процессы (YooKassa, Supabase Edge Functions)

- [ ] Создать Edge Function `POST /payments/create`:
  - Вход:
    `{ items, method: 'sbp' | 'bank_card' | 'yoomoney', order_id?, customer? }`.
  - Сервер валидирует корзину, считает сумму, создаёт `payments` и `orders`
    записи.
  - Запрос в YooKassa `POST /payments` с
    `confirmation: { type: 'redirect', return_url }`.
  - Ответ клиенту: `{ confirmation_url, payment_id }`.
- [ ] Включить чеки (54‑ФЗ): передавать `receipt.items`, `vat_code`,
      `tax_system_code`.
- [ ] Включить идемпотентность (заголовок `Idempotence-Key`) и соответствующее
      поле в БД.
- [ ] Webhooks `POST /payments/webhook`:
  - Обработка `payment.succeeded | payment.canceled | waiting_for_capture`.
  - Идемпотентность по `event_id`, запись в `webhook_events`.
  - Обновление `payments` и `orders` (статусы `paid/failed/canceled`).
- [ ] Настроить return URL (deeplink), напр.: `bixirun://yookassa-return`.
- [ ] Настроить переменные окружения: `STRIPE_*` не нужны, использовать
      `YOOKASSA_SHOP_ID`, `YOOKASSA_SECRET_KEY`, `YOOKASSA_WEBHOOK_SECRET` (если
      применимо).
- [ ] Провести e2e сценарии с тестовыми платёжными данными YooKassa (карты, СБП,
      3‑DS).

### B. Клиент/интеграция

- [ ] Заменить моки на реальные вызовы Edge Function:
  - Для СБП — открывать `confirmation_url` (или deep link в банк) и показывать
    модалку выбора банка только если это часть UX.
  - Для карты/YooMoney — редирект на платёжную страницу `redirect`.
- [ ] Обработать возврат по `return_url`:
  - Парсить deeplink, показать «успех/ошибку», обновить состояние заказа через
    запрос к бэкенду.
- [ ] Состояния UI:
  - Лоадеры, ошибки, повторить оплату/сменить метод, отключение кнопок при
    пустой корзине или нулевой сумме.
- [ ] Локализация текстов (RU/EN) при необходимости.

### C. iOS/Android

- iOS:
  - [ ] Проверить deeplink-схему `CFBundleURLSchemes` в `Info.plist`.
  - [ ] Проверить capabilities/entitlements, если Apple Pay планируется в
        будущем (сейчас не требуется).
- Android:
  - [ ] Тема Material Components уже настроена (в проекте — проверить
        `Theme.MaterialComponents.*`).
  - [ ] ProGuard правила (если будут SDK/Pay-интенты банков).

### D. Данные/БД (Supabase)

- [ ] Таблицы уже созданы согласно миграции: `orders`, `order_items`,
      `payments`, `webhook_events`.
- [ ] Индексы по статусам и датам, внешний ключ `order_id` в `payments`.
- [ ] Согласовать статусы и переходы:
      `draft -> pending -> paid/failed/canceled`.

### E. UX/визуал

- [ ] Выравнивания/отступы как на странице корзины (готово, перепроверить на
      малых экранах).
- [ ] Тайлы не меняют размер при выборе (готово).
- [ ] Кнопка «Оплатить …» всегда синяя, только текст меняется (готово).
- [ ] Официальный логотип СБП подключён (готово).
- [ ] Отображение скидки/итога как в подвале корзины (опционально — решить,
      нужен ли блок «Товары/Скидка/К оплате»).
- [ ] Ховеры/feedback: лёгкий `android_ripple`/opacity без смещения.

### F. Логи/аналитика/диагностика

- [ ] События: выбор метода оплаты, клик «Оплатить», успех/неуспех, возврат из
      банка/редиректа.
- [ ] Лог ошибок с корреляцией `order_id`/`payment_id`.

### G. QA чек‑листы

- [ ] Большая корзина (много строк) — прокрутка, перформанс, адаптация
      заголовка.
- [ ] Пустая корзина — отключение кнопки, корректный UX.
- [ ] Медленный интернет/таймауты — ретраи/тосты.
- [ ] Deeplink с приложением банка и без него.

---

## Быстрые ссылки на ключевые участки кода

- `app/checkout.tsx` — логика UI и моки платёжных сценариев.
- `components/AppLayout.tsx` — скрытие таббара на `'/checkout'`.
- `assets/images/sbp-logo.png` — логотип СБП для тайла способа оплаты.

---

## Примечания

- Финальное подключение YooKassa должно соответствовать их API и требованиям
  54‑ФЗ. Сумму/скидки/НДС считаем строго на сервере.
- Источником истины статуса платежа является вебхук; клиентский результат —
  вторичный.
